
pipeline {

  agent { label 'alpine_controller' }
  
  environment {
    CENTOS_PRIVATE_KEY=credentials('centos_ssh_key') 
  }

  options { skipDefaultCheckout(true) }
  
  stages {

    stage('clean workspace') { 
      steps {
        cleanWs()
      }
    }

    stage('checkout') {
      steps {
        checkout scm
      }
    }    

    stage('CentOS test') {
      
      steps {
        sh 'ansible-galaxy collection install -r requirements.yml'
        sh 'ansible-playbook -i inventory/agents.hosts --private-key=$CENTOS_PRIVATE_KEY playbooks/firewall_test.yml --extra-vars "target_host=centos-agent"'
      }
    
    }
  }

  post { always { cleanWs() } }

}